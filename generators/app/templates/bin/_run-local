#!/usr/bin/env bash

if [[ ! $(which pip) ]]; then
  echo "Error: pip command not found, you can install like this:"
  echo "  $ easy_install pip"
  exit 1
fi

if [[ ! $(which spark-submit) ]]; then
  echo "Error: spark-submit command not found, you need install Apache Spark first. For example:"
  echo "  $ brew install apache-spark"
  exit 1
fi

# Generate packages.zip
mkdir -p .pipcache
pip install . --download .pipcache -q
rm -rf .packages/*  # ensure our own package is latest
pip install . --no-index --find-links .pipcache --target .packages -q
cd ./.packages
zip -r packages.zip -q .
cd ..

spark-submit --master local --py-files .packages/packages.zip <%= pkgName %>/main.py $@
